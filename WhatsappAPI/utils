const { MessageMedia } = require('whatsapp-web.js');
const path = require('path');

/**
 * ğŸ“Œ EnvÃ­a un conjunto de mensajes a un chat.
 */
async function sendMessages(client, chatId, messages) {
    for (const msg of messages) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        await client.sendMessage(chatId, msg);
        console.log(`ğŸ“¤ Mensaje enviado a ${chatId}: ${msg}`);
    }
}

/**
 * ğŸ“Œ EnvÃ­a el QR de pago al usuario.
 */
async function sendPaymentQR(client, chatId) {
    await sendMessages(client, chatId, [
        "ğŸ’³ *Â¡Claro! Aceptamos pagos por QR. ğŸ˜Š*",
        "ğŸ“¥ AquÃ­ tienes el QR para realizar el pago de tan solo *25 Bs.*"
    ]);

    try {
        const media = MessageMedia.fromFilePath(path.join(__dirname, "../qr.png"));
        await new Promise(resolve => setTimeout(resolve, 1000));
        await client.sendMessage(chatId, media);
        console.log(`ğŸ“¤ QR de pago enviado a ${chatId}`);
    } catch (error) {
        console.error("âŒ Error enviando el QR de pago:", error);
    }

    await sendMessages(client, chatId, [
        "ğŸ“Œ *Sigue estos pasos para confirmar tu pago:*\n\n" +
        "1ï¸âƒ£ Adjunta una foto del comprobante de pago. ğŸ“·\n" +
        "2ï¸âƒ£ Luego de realizar el pago, escribe *'YA REALICÃ‰ EL PAGO'* en este chat. âœï¸\n" +
        "3ï¸âƒ£ Revisaremos tu pago y en un mÃ¡ximo de *10 minutos* recibirÃ¡s el enlace de descarga. ğŸ¨âœ¨"
    ]);
}

/**
 * ğŸ“Œ Maneja la confirmaciÃ³n de un pago por parte del usuario.
 */
async function handlePaymentConfirmation(client, chatId) {
    await sendMessages(client, chatId, [
        "âœ… *Â¡Gracias por tu pago!* \n\nğŸ“· *Estamos verificando la transacciÃ³n con tu comprobante de pago.* ğŸ”",
        "âŒ› *Te responderemos en un aproximado de 5 minutos.*"
    ]);

    await client.sendMessage("59169533423@c.us", `ğŸš¨ *Alerta de Pago* ğŸš¨\n\nğŸ“Œ El nÃºmero *${chatId.replace('@c.us', '')}* ha indicado que realizÃ³ el pago.`);
}

module.exports = { sendMessages, sendPaymentQR, handlePaymentConfirmation };
