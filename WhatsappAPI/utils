const { MessageMedia } = require('whatsapp-web.js');
const path = require('path');

/**
 * 📌 Envía un conjunto de mensajes a un chat.
 */
async function sendMessages(client, chatId, messages) {
    for (const msg of messages) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        await client.sendMessage(chatId, msg);
        console.log(`📤 Mensaje enviado a ${chatId}: ${msg}`);
    }
}

/**
 * 📌 Envía el QR de pago al usuario.
 */
async function sendPaymentQR(client, chatId) {
    await sendMessages(client, chatId, [
        "💳 *¡Claro! Aceptamos pagos por QR. 😊*",
        "📥 Aquí tienes el QR para realizar el pago de tan solo *25 Bs.*"
    ]);

    try {
        const media = MessageMedia.fromFilePath(path.join(__dirname, "../qr.png"));
        await new Promise(resolve => setTimeout(resolve, 1000));
        await client.sendMessage(chatId, media);
        console.log(`📤 QR de pago enviado a ${chatId}`);
    } catch (error) {
        console.error("❌ Error enviando el QR de pago:", error);
    }

    await sendMessages(client, chatId, [
        "📌 *Sigue estos pasos para confirmar tu pago:*\n\n" +
        "1️⃣ Adjunta una foto del comprobante de pago. 📷\n" +
        "2️⃣ Luego de realizar el pago, escribe *'YA REALICÉ EL PAGO'* en este chat. ✍️\n" +
        "3️⃣ Revisaremos tu pago y en un máximo de *10 minutos* recibirás el enlace de descarga. 🎨✨"
    ]);
}

/**
 * 📌 Maneja la confirmación de un pago por parte del usuario.
 */
async function handlePaymentConfirmation(client, chatId) {
    await sendMessages(client, chatId, [
        "✅ *¡Gracias por tu pago!* \n\n📷 *Estamos verificando la transacción con tu comprobante de pago.* 🔎",
        "⌛ *Te responderemos en un aproximado de 5 minutos.*"
    ]);

    await client.sendMessage("59169533423@c.us", `🚨 *Alerta de Pago* 🚨\n\n📌 El número *${chatId.replace('@c.us', '')}* ha indicado que realizó el pago.`);
}

module.exports = { sendMessages, sendPaymentQR, handlePaymentConfirmation };
